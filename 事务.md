# 											TCL

**Transaction   Control   Language   ---->事务控制语言**

事务：由一个或者一组sql语句组成一个执行单元，这个执行单元要么全部执行，要么全部不执行，每个sql语句是互相依赖的、如果单元中某条sql语句一旦执行失败或者产生错误，整个单元将会回滚，所有受到影响的数据将返回到事务开始以前的状态。如果执行成功，则执行成功、

案例：转账			张三丰  1000		郭襄      1000

```
update 表 set 张三丰的余额=500 where name=‘ 张三丰’
意外.....
update 表 set  郭襄的余额=1500 where name=‘ 郭襄’
```

- 查看MySQL支持的存储引擎：`show engines;`
- 存储引擎：在mysql中的数据用各种不同的技术存储在文件（或者内存）中，又叫做表结构

**事务的ACID属性：原子性，一致性，隔离性，持久性**--------->事务的特性

1. **原子性（Atomicity）：**

   一个事务不可再分，事务中的操作要么都发生，要么都不发生。

2. **一致性（Consistency）：**

   ​	一个事务执行会使数据从一个一致性状态变换到另一个一致性状态。

3. **隔离性（lsolation）：**

   指一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。关键还是要看隔离级别

4. **持久性（Durability）：**

   持久性是指一个事务一旦被提交，对数据库中的数据的改变就是永久性的，接下来的其他操作和数据库故障不应该对其有任何影响。



事务的创建：

隐式事务：事务没有明显的开启和结束的标记

比如  insert 、update、delete语句

```
//查看变量
mysql> show variables like 'autocommit';(自动提交---->默认的值为ON开启状态)
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | ON    |
+---------------+-------+
1 row in set
```

显式事务：事务具有明显的开启和结束的标记

**前提：必须先设置自动提交功能为禁用**

**set  autocommit=0;**

```
mysql> set  autocommit=0;
Query OK, 0 rows affected
//执行成功，并且将自动提交功能设置成功为关闭状态
mysql> show variables like 'autocommit';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | OFF   |
+---------------+-------+
1 row in set
```

关了仅对当前事务有效，下次事务还需要重新设置。

```
步骤1：开启事务
	set autocommit=0;
	start transaction;可选的
步骤2：编写事务中的sql语句（仅针对select、insert、update、delete）
	语句1，
	语句2，
	....
步骤3：结束事务
    commit;结束事务
    rollback;回滚事务
```

```
演示事务的使用步骤：具体例子

#开启事务
set autocommit=0;
start TRANSACTION;
#编写一组事务的语句
update account set balance =500 where username='张无忌';
update account set balance =1500 where username='赵敏';
#结束事务
commit;

SELECT * from account;
```

对于同时运行的多个事务，当这些事务访问的是数据库中相同的数据时，如果没有采取必要的隔离机制，就会导致各种并发问题：（类似线程的安全问题，可以通过加锁解决）

**脏读：**对于两个事务T1、T2、T1读取了已经被T2**更新**的但是没有提交的字段之后，若T2回滚，T1读取的内容就是临时且无效的。 

**不可重复读：**对于两个事务T1、T2，T1读取了一个字段，然后T2**更新**了该字段之后，T1再次读取哦你跟一个字段，值就不同了。

**幻读：**对于两个事务T1、T2，T1从一个表中读取了一个字段，然后T2在表中**插入**了一些新的行，如果T1再次读取同一张表，就会多处几行。

**数据库事务的隔离性：**

​		数据系统必须具有隔离并发运行各个事务的能力，使它们不会互相影响，避免各种并发问题。（设置隔离级别）

**隔离级别：**

​		一个事务与其他事务隔离的程度称为隔离级别，数据库规定了多种事务隔离级别，不同隔离级对应不同的干扰程度，隔离级别越高，数据一致性就越好，但并发性越弱。

Mysql支持四种事务隔离级别默认的是`repeatable read`